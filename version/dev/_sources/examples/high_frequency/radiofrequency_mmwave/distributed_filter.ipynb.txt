{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "838832ad",
   "metadata": {},
   "source": [
    "# Distributed filter design\n",
    "\n",
    "This example demonstrates using PyAEDT and the ``FilterSolutions`` module to design a low-pass Chebyshev-I filter, \n",
    "visualize its frequency response, and export the distributed model to HFSS.\n",
    "\n",
    "Keywords: **filter solutions**"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "3fdd1520",
   "metadata": {},
   "source": [
    "## Prerequisites\n",
    "\n",
    "### Perform imports"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f34cc383",
   "metadata": {},
   "outputs": [],
   "source": [
    "import os\n",
    "import tempfile\n",
    "import time\n",
    "import ansys.aedt.core\n",
    "import ansys.aedt.core.filtersolutions\n",
    "import matplotlib.pyplot as plt\n",
    "from ansys.aedt.core.filtersolutions_core.attributes import FilterClass, FilterType\n",
    "from ansys.aedt.core.filtersolutions_core.export_to_aedt import ExportFormat\n",
    "from ansys.aedt.core.filtersolutions_core.ideal_response import (\n",
    "    SParametersResponseColumn,\n",
    ")\n",
    "from ansys.aedt.core.filtersolutions_core.distributed_topology import TopologyType\n",
    "from ansys.aedt.core.filtersolutions_core.distributed_substrate import SubstrateType, SubstrateEr, SubstrateResistivity"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "f74203e2",
   "metadata": {},
   "source": [
    "### Define constants.\n",
    "Constants help ensure consistency and avoid repetition throughout the example."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "0f33ff4d",
   "metadata": {},
   "outputs": [],
   "source": [
    "AEDT_VERSION = \"2025.2\""
   ]
  },
  {
   "cell_type": "markdown",
   "id": "13f49af9",
   "metadata": {},
   "source": [
    "### Create temporary directory\n",
    "\n",
    "Create a temporary working directory.\n",
    "The name of the working folder is stored in ``temp_folder.name``.\n",
    "\n",
    "> **Note:** The final cell in the notebook cleans up the temporary folder. If you want to\n",
    "> retrieve the AEDT project and data, do so before executing the final cell in the notebook."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "fb2a703b",
   "metadata": {
    "lines_to_next_cell": 1
   },
   "outputs": [],
   "source": [
    "temp_folder = tempfile.TemporaryDirectory(suffix=\".ansys\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "408e5d66",
   "metadata": {},
   "source": [
    "### Define function used for plotting\n",
    "\n",
    "This function takes a list of datasets, where each dataset contains frequency values,\n",
    "corresponding data values, and a label. It plots the frequency response for each dataset\n",
    "on the same graph, using a logarithmic scale for the x-axis (frequency) and a linear scale\n",
    "for the y-axis (magnitude in dB)."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "65924280",
   "metadata": {
    "lines_to_next_cell": 1
   },
   "outputs": [],
   "source": [
    "def plot(data_list):\n",
    "    for freq, data, label in data_list:\n",
    "        plt.plot(freq, data, linewidth=2.0, label=label)\n",
    "    plt.xlabel(\"Frequency (Hz)\")\n",
    "    plt.ylabel(\"Magnitude S21 (dB)\")\n",
    "    plt.title(\"Frequency Response\")\n",
    "    plt.xscale(\"log\")\n",
    "    plt.legend()\n",
    "    plt.grid()\n",
    "    plt.show()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "322a4df6",
   "metadata": {},
   "source": [
    "### Create distributed filter design\n",
    "\n",
    "Create a distributed filter design using DistributedDesign function form FilterSolutions\n",
    "module and assign the class, type, frequency, and order.\n",
    "This example creates a low-pass Chebyshev-I filter with a center \n",
    "frequency of 2 GHz and a filter order of 7. The default values for other parameters are used.\n",
    "These design is created in the specified AEDT version. The parmeters define the filter's characteristics."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "5aec388b",
   "metadata": {},
   "outputs": [],
   "source": [
    "distributed_design = ansys.aedt.core.filtersolutions.DistributedDesign(version=AEDT_VERSION,)\n",
    "distributed_design.attributes.filter_class = FilterClass.LOW_PASS\n",
    "distributed_design.attributes.filter_type = FilterType.CHEBYSHEV_I\n",
    "distributed_design.attributes.pass_band_center_frequency = \"2 GHz\"\n",
    "distributed_design.attributes.filter_order = 7"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "bc9337d1",
   "metadata": {
    "lines_to_next_cell": 2
   },
   "source": [
    "### Define minimum and maximum analysis frequencies\n",
    "\n",
    "Specify the frequency range for the analysis, from 200 MHz to 4 GHz.\n",
    "This range sets the bandwidth over which the filter response will be evaluated."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "5709726d",
   "metadata": {},
   "outputs": [],
   "source": [
    "distributed_design.graph_setup.minimum_frequency = \"200 MHz\"\n",
    "distributed_design.graph_setup.maximum_frequency = \"4 GHz\""
   ]
  },
  {
   "cell_type": "markdown",
   "id": "eb6b2655",
   "metadata": {},
   "source": [
    "### Define topology and substrate parameters\n",
    "\n",
    "Specify the filter topology, substrate type, dielectric constant, and substrate resistivity.\n",
    "In this example, the topology is set to stepped impedance, the substrate type to microstrip,\n",
    "the conductor material to silver, and the substrate material to alumina.\n",
    "The conductor thickness is set to 2 micrometers, and the dielectric height is set to 200 micrometers."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "6bad4b05",
   "metadata": {},
   "outputs": [],
   "source": [
    "distributed_design.topology.topology_type = TopologyType.STEPPED_IMPEDANCE\n",
    "distributed_design.substrate.substrate_type = SubstrateType.MICROSTRIP\n",
    "distributed_design.substrate.substrate_er = SubstrateEr.ALUMINA\n",
    "distributed_design.substrate.substrate_resistivity = SubstrateResistivity.SILVER\n",
    "distributed_design.substrate.substrate_conductor_thickness = \"2um\"\n",
    "distributed_design.substrate.substrate_dielectric_height = \"200 um\""
   ]
  },
  {
   "cell_type": "markdown",
   "id": "4d23e1e6",
   "metadata": {},
   "source": [
    "### Plot frequency response of the filter\n",
    "\n",
    "Plot the synthesized frequency response to visualize the transmission and reflection\n",
    "characteristics of filter over the defined frequency range.\n",
    "The frequency response is obtained from the ideal response of the distributed design.\n",
    "The S-parameters S11 and S21 in dB are plotted against frequency."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "7c1f4643",
   "metadata": {},
   "outputs": [],
   "source": [
    "freq, s11_db = distributed_design.ideal_response.s_parameters(SParametersResponseColumn.S11_DB)\n",
    "freq, s21_db = distributed_design.ideal_response.s_parameters(SParametersResponseColumn.S21_DB)\n",
    "plot_data = [\n",
    "    (freq, s11_db, \"Synthesized S11\"),\n",
    "    (freq, s21_db, \"Synthesized S21\"),\n",
    "]\n",
    "plot(plot_data)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "7f6a54e0",
   "metadata": {},
   "source": [
    "<img src=\"_static/distributed_filter_response.png\" width=\"400\">"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "8e7660ce",
   "metadata": {},
   "source": [
    "### Export distributed model of the filter to HFSS 3D Layout and simulate\n",
    "\n",
    "The designed filter is exported as a distributed model to Ansys HFSS 3D Layout \n",
    "and simulated using the specified export parameters.\n",
    "During export, the target schematic name is set, along with any required reports.\n",
    "In this workflow:\n",
    "Automatic simulation in HFSS 3D Layout is enabled after export.\n",
    "OptiMetrics is disabled to reduce overall simulation time.\n",
    "S-parameter reports (S11 and S21) are included by enabling the corresponding export options.\n",
    "The HFSS 3D Layout environment is selected as the destination for generating and simulating the distributed model."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "d20c88a7",
   "metadata": {},
   "outputs": [],
   "source": [
    "project_name = os.path.join(temp_folder.name, \"DistributedFilter\")\n",
    "distributed_design.export_to_aedt.schematic_name = project_name\n",
    "distributed_design.export_to_aedt.simulate_after_export_enabled = True\n",
    "distributed_design.export_to_aedt.optimitrics_enabled = False\n",
    "distributed_design.export_to_aedt.include_forward_transfer_s21_enabled  = True\n",
    "distributed_design.export_to_aedt.include_return_loss_s11_enabled = True\n",
    "distributed_design.export_to_aedt.insert_hfss_3dl_design = True\n",
    "hfss3dl = distributed_design.export_to_aedt.export_design(export_format=ExportFormat.DIRECT_TO_AEDT)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "e27081b5",
   "metadata": {},
   "source": [
    "<img src=\"_static/desktop_results_distributed_filter.png\" width=\"400\">"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "dde144ad",
   "metadata": {},
   "source": [
    "### Plot the simulated design\n",
    "\n",
    "Get the scattering parameter data from the AEDT HFSS 3D Layout simulation and create a plot.\n",
    "To update the plot with the simulated data, the HFSS 3D Layout design is analyzed using the analyze method.\n",
    "The S-parameters S11 and S21 in dB are extracted from the simulation results and plotted against frequency.\n",
    "The simulated S-parameters are overlaid on the synthesized frequency response for comparison."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "e0ba5fd4",
   "metadata": {},
   "outputs": [],
   "source": [
    "hfss3dl.analyze()\n",
    "solutions = hfss3dl.post.get_solution_data(\n",
    "    expressions=hfss3dl.get_traces_for_plot(category=\"S\"),\n",
    "    report_category=\"Standard\",\n",
    ")\n",
    "sim_freq = solutions.primary_sweep_values\n",
    "sim_freq_ghz = [i * 1e9 for i in sim_freq]\n",
    "sim_s11_db = solutions.get_expression_data(\"S(Port1,Port1)\", \"dB20\")[1]\n",
    "sim_s21_db = solutions.get_expression_data(\"S(Port2,Port1)\", \"dB20\")[1]\n",
    "plot_data = [\n",
    "    (freq, s11_db, \"Synthesized S11\"),\n",
    "    (freq, s21_db, \"Synthesized S21\"),\n",
    "    (sim_freq_ghz, sim_s11_db, \"Simulated S11\"),\n",
    "    (sim_freq_ghz, sim_s21_db, \"Simulated S21\")\n",
    "]\n",
    "plot(plot_data)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "9469befb",
   "metadata": {
    "lines_to_next_cell": 2
   },
   "source": [
    "<img src=\"_static/simulated_distributed_filter.png\" width=\"400\">"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "386a0ca0",
   "metadata": {},
   "source": [
    "## Finish\n",
    "\n",
    "### Save the project"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "6068f1c5",
   "metadata": {},
   "outputs": [],
   "source": [
    "hfss3dl.save_project()\n",
    "hfss3dl.release_desktop()\n",
    "# Wait 3 seconds to allow AEDT to shut down before cleaning the temporary directory.\n",
    "time.sleep(3)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "6d0d423a",
   "metadata": {},
   "source": [
    "### Clean up\n",
    "\n",
    "All project files are saved in the folder ``temp_folder.name``.\n",
    "If you've run this example as a Jupyter notebook, you\n",
    "can retrieve those project files. The following cell\n",
    "removes all temporary files, including the project folder."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "cafcbc9d",
   "metadata": {},
   "outputs": [],
   "source": [
    "temp_folder.cleanup()"
   ]
  }
 ],
 "metadata": {
  "jupytext": {
   "cell_metadata_filter": "-all",
   "main_language": "python",
   "notebook_metadata_filter": "-all"
  },
  "nbsphinx": {
   "execute": "never"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
